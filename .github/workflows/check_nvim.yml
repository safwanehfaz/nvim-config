name: Update Neovim Version

on:
  schedule:
    - cron: '0 0 */3 * *' # Runs every 3 days at midnight
  workflow_dispatch:      # Allows manual trigger by the owner

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # Required to push changes back to the repository

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Latest Neovim Tag
        id: get_tag
        run: |
          # Fetch the latest release tag from Neovim GitHub API
          LATEST_TAG=$(curl -s -H "Authorization: Bearer ${{ github.token }}" https://api.github.com/repos/neovim/neovim/releases/latest | jq -r .tag_name)
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "Error: Retrieved Neovim tag is empty or invalid." >&2
            exit 1
          fi
          echo "latest_tag=$LATEST_TAG" >> "$GITHUB_OUTPUT"

      - name: Check and Update Version
        id: check_version
        run: |
          # Read the version currently stored in the repository
          if [ -f nvim_version.txt ]; then
            CURRENT_FILE_VERSION=$(cat nvim_version.txt)
          else
            CURRENT_FILE_VERSION="none"
          fi

          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"

          echo "Stored version: $CURRENT_FILE_VERSION"
          echo "Latest available: $LATEST_TAG"

          # Compare stored version with latest available version
          if [ "$CURRENT_FILE_VERSION" = "$LATEST_TAG" ]; then
            echo "Version is already up to date. No changes needed."
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "$LATEST_TAG" > nvim_version.txt
            echo "New version detected! Updating file."
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and Push Changes
        if: steps.check_version.outputs.changed == 'true'
        run: |
          # Configure git with GitHub Actions bot identity
          git config --global user.name "github-actions[bot]"

          git push || { echo "Push failed"; exit 1; }
          
          git add nvim_version.txt
          git commit -m "Update Neovim version to ${{ steps.get_tag.outputs.latest_tag }}"
          git push